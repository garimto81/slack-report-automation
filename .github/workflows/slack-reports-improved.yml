name: Automated Slack Reports (Improved)

on:
  schedule:
    # ì¼ê°„ ë³´ê³ ì„œ - ë§¤ì¼ ì˜¤ì „ 9ì‹œ (í•œêµ­ ì‹œê°„)
    - cron: '0 0 * * *'  # UTC 0:00 = KST 9:00
    # ì£¼ê°„ ë³´ê³ ì„œ - ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ 30ë¶„ (í•œêµ­ ì‹œê°„)  
    - cron: '30 0 * * 1'  # UTC 0:30 Monday = KST 9:30 Monday
    # ì›”ê°„ ë³´ê³ ì„œ - ë§¤ì›” 1ì¼ ì˜¤ì „ 10ì‹œ (í•œêµ­ ì‹œê°„)
    - cron: '0 1 1 * *'  # UTC 1:00 1st = KST 10:00 1st
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - daily
          - weekly
          - monthly
  push:
    branches:
      - main
      - clean-deployment-branch

env:
  TZ: Asia/Seoul
  NODE_VERSION: '18'

jobs:
  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          echo "âœ… Dependencies installed successfully"

      - name: Determine report types to generate
        id: report
        run: |
          echo "ğŸ” Determining report types..."
          REPORTS_TO_GENERATE=""
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.report_type }}" = "all" ]; then
              REPORTS_TO_GENERATE="daily,weekly,monthly"
            else
              REPORTS_TO_GENERATE="${{ github.event.inputs.report_type }}"
            fi
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            # ìŠ¤ì¼€ì¤„ ì‹œê°„ìœ¼ë¡œ êµ¬ë¶„
            CRON_SCHEDULE="${{ github.event.schedule }}"
            
            # ê° ìŠ¤ì¼€ì¤„ì— ë”°ë¼ ë‹¤ë¥¸ ë³´ê³ ì„œ ìƒì„±
            if [ "$CRON_SCHEDULE" = "0 0 * * *" ]; then
              # ë§¤ì¼ ì˜¤ì „ 9ì‹œ - ì¼ê°„ ë³´ê³ ì„œ
              REPORTS_TO_GENERATE="daily"
            elif [ "$CRON_SCHEDULE" = "30 0 * * 1" ]; then
              # ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ 30ë¶„ - ì£¼ê°„ ë³´ê³ ì„œ
              REPORTS_TO_GENERATE="weekly"
            elif [ "$CRON_SCHEDULE" = "0 1 1 * *" ]; then
              # ë§¤ì›” 1ì¼ ì˜¤ì „ 10ì‹œ - ì›”ê°„ ë³´ê³ ì„œ
              REPORTS_TO_GENERATE="monthly"
            else
              # ê¸°ë³¸ê°’: ë‚ ì§œ ê¸°ë°˜ íŒë‹¨
              REPORTS_TO_GENERATE="daily"
              
              # ì›”ìš”ì¼ì´ë©´ ì£¼ê°„ ë³´ê³ ì„œ ì¶”ê°€
              if [ "$(date +%u)" = "1" ]; then
                REPORTS_TO_GENERATE="${REPORTS_TO_GENERATE},weekly"
              fi
              
              # 1ì¼ì´ë©´ ì›”ê°„ ë³´ê³ ì„œ ì¶”ê°€
              if [ "$(date +%d)" = "01" ]; then
                REPORTS_TO_GENERATE="${REPORTS_TO_GENERATE},monthly"
              fi
            fi
          else
            # Push ì´ë²¤íŠ¸ì¼ ê²½ìš° í…ŒìŠ¤íŠ¸ ëª¨ë“œ
            REPORTS_TO_GENERATE="test"
          fi
          
          echo "reports=${REPORTS_TO_GENERATE}" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Reports to generate: ${REPORTS_TO_GENERATE}"
          echo "ğŸ• Current time (KST): $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“… Day of week: $(date +%A) ($(date +%u))"
          echo "ğŸ“… Day of month: $(date +%d)"

      - name: Test mode - Verify scripts
        if: contains(steps.report.outputs.reports, 'test')
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ§ª Running in test mode..."
          
          # íŒŒì¼ ì¡´ì¬ í™•ì¸
          echo "Checking required files..."
          [ -f "generate-full-report.js" ] && echo "âœ… generate-full-report.js exists" || echo "âŒ generate-full-report.js not found"
          [ -f "test-grouping-logic.js" ] && echo "âœ… test-grouping-logic.js exists" || echo "âŒ test-grouping-logic.js not found"
          
          # ê·¸ë£¹í™” ë¡œì§ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (ì‹¤ì œ ë©”ì‹œì§€ ì „ì†¡ ì—†ìŒ)
          if [ -f "test-grouping-logic.js" ]; then
            echo "Running grouping logic test..."
            node test-grouping-logic.js daily || echo "Test completed with status $?"
          fi
          
          echo "âœ… Test mode completed"

      - name: Generate Daily Report
        if: contains(steps.report.outputs.reports, 'daily')
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“… Generating daily report at $(TZ=Asia/Seoul date '+%H:%M KST')..."
          node generate-full-report.js daily
          echo "âœ… Daily report sent successfully"

      - name: Generate Weekly Report
        if: contains(steps.report.outputs.reports, 'weekly')
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“… Generating weekly report at $(TZ=Asia/Seoul date '+%H:%M KST')..."
          node generate-full-report.js weekly
          echo "âœ… Weekly report sent successfully"

      - name: Generate Monthly Report
        if: contains(steps.report.outputs.reports, 'monthly')
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“… Generating monthly report at $(TZ=Asia/Seoul date '+%H:%M KST')..."
          node generate-full-report.js monthly
          echo "âœ… Monthly report sent successfully"

      - name: Summary
        if: always()
        run: |
          echo "ğŸ¯ Workflow Summary"
          echo "==================="
          echo "Event: ${{ github.event_name }}"
          echo "Reports Generated: ${{ steps.report.outputs.reports }}"
          echo "Timestamp (KST): $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')"
          echo "Day Info: $(date +%A), $(date +%B) $(date +%d)"
          echo "Status: ${{ job.status }}"