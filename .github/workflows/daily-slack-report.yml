name: Daily Slack Report

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 9ì‹œ ì‹¤í–‰ (ì›”-ê¸ˆ, í•œêµ­ ì‹œê°„)
    # UTC 0:00 = KST 9:00
    - cron: '0 0 * * 1-5'  # ì›”ìš”ì¼(1) ~ ê¸ˆìš”ì¼(5)ë§Œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto      # ìžë™ íŒë‹¨ (ìš°ì„ ìˆœìœ„ ê¸°ë°˜)
          - daily     # ê°•ì œ ì¼ê°„
          - weekly    # ê°•ì œ ì£¼ê°„
          - monthly   # ê°•ì œ ì›”ê°„
  push:
    branches:
      - main
      - clean-deployment-branch

env:
  TZ: Asia/Seoul
  NODE_VERSION: '18'

jobs:
  generate-report:
    name: Generate Weekday Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm install
          echo "âœ… Dependencies installed successfully"

      - name: Check if today is weekday
        id: weekday
        run: |
          DAY_OF_WEEK=$(date +%u)
          echo "ðŸ“… Today is $(date +%A) (Day $DAY_OF_WEEK)"
          
          if [ $DAY_OF_WEEK -ge 1 ] && [ $DAY_OF_WEEK -le 5 ]; then
            echo "is_weekday=true" >> $GITHUB_OUTPUT
            echo "âœ… Today is a weekday - proceeding with report"
          else
            echo "is_weekday=false" >> $GITHUB_OUTPUT
            echo "ðŸš« Today is weekend - skipping report"
          fi

      - name: Determine report type (Priority based)
        id: report
        if: steps.weekday.outputs.is_weekday == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ” Determining report type with priority..."
          echo "ðŸ“Š Priority: Monthly > Weekly > Daily"
          
          REPORT_TYPE=""
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.report_type }}" = "auto" ]; then
              # ìžë™ íŒë‹¨ ëª¨ë“œ
              echo "ðŸ¤– Auto mode - checking priorities..."
            else
              # ìˆ˜ë™ ì„ íƒ ëª¨ë“œ
              REPORT_TYPE="${{ github.event.inputs.report_type }}"
              echo "ðŸ‘¤ Manual mode - selected: $REPORT_TYPE"
            fi
          fi
          
          # ìžë™ íŒë‹¨ ë¡œì§ (ìš°ì„ ìˆœìœ„: ì›”ê°„ > ì£¼ê°„ > ì¼ê°„)
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "auto" ]; then
            DAY_OF_MONTH=$(date +%d)
            DAY_OF_WEEK=$(date +%u)
            
            echo "ðŸ“… Current date info:"
            echo "   - Date: $(date '+%Y-%m-%d')"
            echo "   - Day of month: $DAY_OF_MONTH"
            echo "   - Day of week: $DAY_OF_WEEK ($(date +%A))"
            
            # ìš°ì„ ìˆœìœ„ 1: ì›”ê°„ ë³´ê³ ì„œ (ë§¤ì›” 1ì¼)
            if [ "$DAY_OF_MONTH" = "01" ]; then
              REPORT_TYPE="monthly"
              echo "ðŸ“Š Monthly report day detected (1st of month)"
            # ìš°ì„ ìˆœìœ„ 2: ì£¼ê°„ ë³´ê³ ì„œ (ë§¤ì£¼ ì›”ìš”ì¼, 1ì¼ì´ ì•„ë‹Œ ê²½ìš°)
            elif [ "$DAY_OF_WEEK" = "1" ]; then
              REPORT_TYPE="weekly"
              echo "ðŸ“Š Weekly report day detected (Monday)"
            # ìš°ì„ ìˆœìœ„ 3: ì¼ê°„ ë³´ê³ ì„œ (ê·¸ ì™¸ í‰ì¼)
            else
              REPORT_TYPE="daily"
              echo "ðŸ“Š Daily report day (regular weekday)"
            fi
          fi
          
          # Push ì´ë²¤íŠ¸ëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œ
          if [ "${{ github.event_name }}" = "push" ]; then
            REPORT_TYPE="test"
            echo "ðŸ§ª Push event detected - running in test mode"
          fi
          
          echo "report_type=${REPORT_TYPE}" >> $GITHUB_OUTPUT
          echo "âœ… Final decision: ${REPORT_TYPE} report"
          
          # ë³´ê³ ì„œ íƒ€ìž…ë³„ ì„¤ëª…
          case $REPORT_TYPE in
            monthly)
              echo "ðŸ“‹ Will generate MONTHLY report (covers last 30 days)"
              echo "   Includes all weekly and daily activities"
              ;;
            weekly)
              echo "ðŸ“‹ Will generate WEEKLY report (covers last 7 days)"
              echo "   Includes all daily activities for the week"
              ;;
            daily)
              echo "ðŸ“‹ Will generate DAILY report (covers last 24 hours)"
              ;;
            test)
              echo "ðŸ“‹ Will run TEST mode (no actual reports sent)"
              ;;
          esac

      - name: Skip weekend execution
        if: steps.weekday.outputs.is_weekday == 'false' && github.event_name != 'workflow_dispatch'
        run: |
          echo "â­ï¸ Skipping weekend execution"
          echo "ðŸ“… Reports are only generated on weekdays (Monday-Friday)"
          echo "ðŸ’¡ Use manual workflow dispatch to generate reports on weekends"
          exit 0

      - name: Test mode - Verify scripts
        if: steps.report.outputs.report_type == 'test'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸ§ª Running in test mode..."
          
          # íŒŒì¼ ì¡´ìž¬ í™•ì¸
          echo "Checking required files..."
          [ -f "generate-full-report.js" ] && echo "âœ… generate-full-report.js exists" || echo "âŒ generate-full-report.js not found"
          [ -f "test-grouping-logic.js" ] && echo "âœ… test-grouping-logic.js exists" || echo "âŒ test-grouping-logic.js not found"
          
          # ê·¸ë£¹í™” ë¡œì§ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (ì‹¤ì œ ë©”ì‹œì§€ ì „ì†¡ ì—†ìŒ)
          if [ -f "test-grouping-logic.js" ]; then
            echo "Running grouping logic test..."
            node test-grouping-logic.js daily || echo "Test completed with status $?"
          fi
          
          echo "âœ… Test mode completed"

      - name: Generate Daily Report
        if: steps.report.outputs.report_type == 'daily'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“… DAILY REPORT GENERATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ• Time: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ðŸ“Š Coverage: Last 24 hours"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          node generate-full-report.js daily
          
          echo "âœ… Daily report sent successfully"

      - name: Generate Weekly Report
        if: steps.report.outputs.report_type == 'weekly'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“… WEEKLY REPORT GENERATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ• Time: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ðŸ“Š Coverage: Last 7 days"
          echo "ðŸ’¡ Note: Replaces daily report for today"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          node generate-full-report.js weekly
          
          echo "âœ… Weekly report sent successfully"

      - name: Generate Monthly Report
        if: steps.report.outputs.report_type == 'monthly'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“… MONTHLY REPORT GENERATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ• Time: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ðŸ“Š Coverage: Last 30 days"
          echo "ðŸ’¡ Note: Replaces weekly and daily reports for today"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          node generate-full-report.js monthly
          
          echo "âœ… Monthly report sent successfully"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      WORKFLOW EXECUTION SUMMARY     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Report Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Event Type: ${{ github.event_name }}"
          echo "Report Type: ${{ steps.report.outputs.report_type }}"
          echo "Is Weekday: ${{ steps.weekday.outputs.is_weekday }}"
          echo ""
          echo "ðŸ“… Time Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "KST Time: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')"
          echo "Day: $(date +%A), $(date +%B) $(date +%d), $(date +%Y)"
          echo ""
          echo "âœ… Status: ${{ job.status }}"
          echo ""
          echo "ðŸ“‹ Priority Rules Applied:"
          echo "  1. Monthly (1st) > Weekly (Monday) > Daily"
          echo "  2. Weekdays only (Mon-Fri)"
          echo "  3. Single report per day"
          echo ""