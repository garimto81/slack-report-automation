name: Automated Slack Reports

on:
  schedule:
    - cron: '0 0 * * 1-5'  # 평일 오전 9시 (KST)
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - daily
          - weekly
          - monthly

env:
  TZ: Asia/Seoul

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - run: npm install

      - name: Determine report type
        id: report
        run: |
          REPORT_TYPE=""
          DAY_OF_WEEK=$(date +%u)
          DAY_OF_MONTH=$(date +%d)
          
          # 주말 스킵
          if [ $DAY_OF_WEEK -ge 6 ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            REPORT_TYPE="skip"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPORT_TYPE="${{ github.event.inputs.report_type }}"
          fi
          
          # 자동 우선순위: 월간 > 주간 > 일간
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "auto" ]; then
            if [ "$DAY_OF_WEEK" = "1" ] && [ "$DAY_OF_MONTH" -ge 1 ] && [ "$DAY_OF_MONTH" -le 7 ]; then
              REPORT_TYPE="monthly"
            elif [ "$DAY_OF_WEEK" = "1" ]; then
              REPORT_TYPE="weekly"
            else
              REPORT_TYPE="daily"
            fi
          fi
          
          echo "report_type=${REPORT_TYPE}" >> $GITHUB_OUTPUT
          echo "✅ Report type: ${REPORT_TYPE}"

      - name: Generate Report
        if: steps.report.outputs.report_type != 'skip'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          REPORT_TYPE="${{ steps.report.outputs.report_type }}"
          echo "📊 Generating ${REPORT_TYPE} report..."
          node generate-full-report.js $REPORT_TYPE
          echo "✅ Report sent successfully"