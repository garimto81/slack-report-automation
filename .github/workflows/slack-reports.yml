# .github/workflows/automated-reports.yml

name: Automated Slack Reports

on:
  # 1. ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ì›”ìš”ì¼-ê¸ˆìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
  schedule:
    - cron: '0 0 * * 1-5'  # UTC 0ì‹œ = KST ì˜¤ì „ 9ì‹œ (í‰ì¼)

  # 2. ìˆ˜ë™ ì‹¤í–‰: í•„ìš”ì‹œ 'auto', 'daily', 'weekly', 'monthly' ë¦¬í¬íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ì§ì ‘ ì‹¤í–‰í•©ë‹ˆë‹¤.
  workflow_dispatch:
    inputs:
      report_type:
        description: 'ì‹¤í–‰í•  ë¦¬í¬íŠ¸ ì¢…ë¥˜ ì„ íƒ'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - daily
          - weekly
          - monthly

  # 3. ì½”ë“œ ë³€ê²½ ì‹œ í…ŒìŠ¤íŠ¸: main ë¸Œëœì¹˜ì— push ë˜ëŠ” pull requestê°€ ë°œìƒí–ˆì„ ë•Œ í…ŒìŠ¤íŠ¸ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# ëª¨ë“  ì‘ì—…ì— ê³µí†µìœ¼ë¡œ ì ìš©ë  í™˜ê²½ ë³€ìˆ˜
env:
  TZ: Asia/Seoul

jobs:
  # ===============================================
  # ==      ë¦¬í¬íŠ¸ ìƒì„± ì‘ì—… (ìŠ¤ì¼€ì¤„/ìˆ˜ë™ ì‹¤í–‰)      ==
  # ===============================================
  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    # ìŠ¤ì¼€ì¤„ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ì¼ ë•Œë§Œ ì´ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm' # npm ìºì‹± í™œì„±í™”

      # 3. NPM ì˜ì¡´ì„± ì„¤ì¹˜ (npm ci ì‚¬ìš©ì„ ê¶Œì¥)
      - name: Install dependencies
        run: npm ci # package-lock.jsonì„ ê¸°ë°˜ìœ¼ë¡œ ë” ë¹ ë¥´ê³  ì•ˆì •ì ìœ¼ë¡œ ì„¤ì¹˜

      # 4. ì‹¤í–‰í•  ë¦¬í¬íŠ¸ ì¢…ë¥˜ ê²°ì •
      - name: Determine report type
        id: report
        run: |
          REPORT_TYPE=""
          # ìˆ˜ë™ ì‹¤í–‰ì˜ ê²½ìš°, ì…ë ¥ë°›ì€ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPORT_TYPE="${{ github.event.inputs.report_type }}"
          fi
          
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ì—ì„œ 'auto'ë¥¼ ì„ íƒí•œ ê²½ìš°, ë‚ ì§œì— ë”°ë¼ ìë™ ê²°ì •
          # ìš°ì„ ìˆœìœ„: ì›”ê°„ > ì£¼ê°„ > ì¼ê°„
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "auto" ]; then
            DAY_OF_WEEK=$(date +%u)
            DAY_OF_MONTH=$(date +%d)
            
            # ë§¤ì›” ì²«ì§¸ ì£¼ ì›”ìš”ì¼ì´ë©´ ì›”ê°„ ë¦¬í¬íŠ¸
            if [ "$DAY_OF_WEEK" = "1" ] && [ "$DAY_OF_MONTH" -le 7 ]; then
              REPORT_TYPE="monthly"
            # ì›”ìš”ì¼ì´ë©´ ì£¼ê°„ ë¦¬í¬íŠ¸
            elif [ "$DAY_OF_WEEK" = "1" ]; then
              REPORT_TYPE="weekly"
            # ê·¸ ì™¸ í‰ì¼ì€ ì¼ê°„ ë¦¬í¬íŠ¸
            else
              REPORT_TYPE="daily"
            fi
          fi
          
          echo "report_type=${REPORT_TYPE}" >> "$GITHUB_OUTPUT"
          echo "âœ… Report type determined: ${REPORT_TYPE}"

      # 5. ë¦¬í¬íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Generate Report
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          REPORT_TYPE="${{ steps.report.outputs.report_type }}"
          echo "ğŸ“Š Generating ${REPORT_TYPE} report..."
          node generate-full-report.js $REPORT_TYPE
          echo "âœ… Report sent successfully"

  # ===============================================
  # ==          ë¡œì§ í…ŒìŠ¤íŠ¸ ì‘ì—… (Push/PR)          ==
  # ===============================================
  test-logic:
    name: Test Logic
    runs-on: ubuntu-latest
    # Push ë˜ëŠ” Pull Requestì¼ ë•Œë§Œ ì´ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Test Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ§ª Testing logic..."
          node test-grouping-logic.js
          echo "âœ… Logic test completed"
