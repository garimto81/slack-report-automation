name: Automated Slack Reports

on:
  schedule:
    # í‰ì¼ ì˜¤ì „ 9ì‹œë§Œ ì‹¤í–‰ (ì›”-ê¸ˆ, í•œêµ­ ì‹œê°„)
    # UTC 0:00 = KST 9:00
    - cron: '0 0 * * 1-5'  # ì›”ìš”ì¼(1) ~ ê¸ˆìš”ì¼(5)
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto      # ìë™ íŒë‹¨
          - daily     # ì¼ê°„ ë³´ê³ ì„œ
          - weekly    # ì£¼ê°„ ë³´ê³ ì„œ
          - monthly   # ì›”ê°„ ë³´ê³ ì„œ
  push:
    branches:
      - main
      - clean-deployment-branch

env:
  TZ: Asia/Seoul

jobs:
  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Show environment
        run: |
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‹ Files:"
          ls -la
          echo ""
          echo "ğŸ”§ Node version: $(node --version)"
          echo "ğŸ“¦ NPM version: $(npm --version)"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          echo "ğŸ“ Current working directory: $(pwd)"
          echo "ğŸ“‹ Contents:"
          ls -la
          echo ""
          
          if [ -f "package.json" ]; then
            echo "âœ… package.json found"
            echo "ğŸ“¦ Running npm install..."
            npm install --no-fund --no-audit
            echo "âœ… Dependencies installed successfully"
            echo ""
            echo "ğŸ“‹ node_modules created:"
            [ -d "node_modules" ] && echo "âœ… node_modules exists" || echo "âŒ node_modules not found"
          else
            echo "âŒ package.json not found!"
            echo "ğŸ“ Files in current directory:"
            ls -la
            exit 1
          fi

      - name: Determine report type
        id: report
        run: |
          echo "ğŸ” Determining report type..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… Date: $(TZ=Asia/Seoul date '+%Y-%m-%d %A')"
          echo "ğŸ• Time: $(TZ=Asia/Seoul date '+%H:%M:%S KST')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          REPORT_TYPE=""
          DAY_OF_WEEK=$(date +%u)
          DAY_OF_MONTH=$(date +%d)
          
          # ì£¼ë§ ì²´í¬
          if [ $DAY_OF_WEEK -ge 6 ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "ğŸš« Weekend detected - skipping automatic report"
            REPORT_TYPE="skip"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # ìˆ˜ë™ ì‹¤í–‰
            if [ "${{ github.event.inputs.report_type }}" = "auto" ]; then
              echo "ğŸ¤– Auto mode selected - applying priority rules"
            else
              REPORT_TYPE="${{ github.event.inputs.report_type }}"
              echo "ğŸ‘¤ Manual override: $REPORT_TYPE"
            fi
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Push ì´ë²¤íŠ¸ëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œ
            REPORT_TYPE="test"
            echo "ğŸ§ª Test mode for push event"
          fi
          
          # ìë™ ìš°ì„ ìˆœìœ„ íŒë‹¨ (ì›”ê°„ > ì£¼ê°„ > ì¼ê°„)
          if [ -z "$REPORT_TYPE" ] || [ "$REPORT_TYPE" = "auto" ]; then
            # ì²«ì§¸ì£¼ ì›”ìš”ì¼ ì²´í¬ (1-7ì¼ ì‚¬ì´ì˜ ì›”ìš”ì¼)
            if [ "$DAY_OF_WEEK" = "1" ] && [ "$DAY_OF_MONTH" -ge 1 ] && [ "$DAY_OF_MONTH" -le 7 ]; then
              REPORT_TYPE="monthly"
              echo "ğŸ“Š Priority 1: MONTHLY (First Monday of month)"
              echo "ğŸ’¡ This replaces weekly and daily reports"
            elif [ "$DAY_OF_WEEK" = "1" ]; then
              REPORT_TYPE="weekly"
              echo "ğŸ“Š Priority 2: WEEKLY (Monday)"
              echo "ğŸ’¡ This replaces daily report"
            else
              REPORT_TYPE="daily"
              echo "ğŸ“Š Priority 3: DAILY (regular weekday)"
            fi
          fi
          
          echo "report_type=${REPORT_TYPE}" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Decision: ${REPORT_TYPE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Skip weekend
        if: steps.report.outputs.report_type == 'skip'
        run: |
          echo "â­ï¸ Skipping weekend execution"
          exit 0

      - name: Test mode
        if: steps.report.outputs.report_type == 'test'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ§ª Running test mode..."
          if [ -f "test-grouping-logic.js" ]; then
            node test-grouping-logic.js daily || true
          fi
          echo "âœ… Test completed"

      - name: Generate Report
        if: steps.report.outputs.report_type != 'skip' && steps.report.outputs.report_type != 'test'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          REPORT_TYPE="${{ steps.report.outputs.report_type }}"
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   Generating ${REPORT_TYPE^^} Report    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          node generate-full-report.js $REPORT_TYPE
          
          echo "âœ… ${REPORT_TYPE} report sent successfully"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š Execution Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Report: ${{ steps.report.outputs.report_type }}"
          echo "Time: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
          echo "Status: ${{ job.status }}"