# .github/workflows/automated-reports.yml

name: Automated Slack Reports

on:
  # 1. ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
  schedule:
    - cron: '0 0 * * *'  # UTC 0ì‹œ = KST ì˜¤ì „ 9ì‹œ

  # 2. ìˆ˜ë™ ì‹¤í–‰: í•„ìš”ì‹œ 'daily', 'weekly', 'monthly' ë¦¬í¬íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ì§ì ‘ ì‹¤í–‰í•©ë‹ˆë‹¤.
  workflow_dispatch:
    inputs:
      report_type:
        description: 'ì‹¤í–‰í•  ë¦¬í¬íŠ¸ ì¢…ë¥˜ ì„ íƒ'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - monthly

  # 3. ì½”ë“œ ë³€ê²½ ì‹œ í…ŒìŠ¤íŠ¸: main ë¸Œëœì¹˜ì— push ë˜ëŠ” pull requestê°€ ë°œìƒí–ˆì„ ë•Œ í…ŒìŠ¤íŠ¸ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ===============================================
  # ==      ë¦¬í¬íŠ¸ ìƒì„± ì‘ì—… (ì¼ê°„/ì£¼ê°„/ì›”ê°„)       ==
  # ===============================================
  generate-report:
    # ì‘ì—… ì´ë¦„ì— ë§¤íŠ¸ë¦­ìŠ¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ ë¦¬í¬íŠ¸ì¸ì§€ ëª…í™•íˆ í‘œì‹œí•©ë‹ˆë‹¤.
    name: Generate ${{ matrix.report_type }} Report
    runs-on: ubuntu-latest

    # 'matrix' ì „ëµì„ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µë˜ëŠ” ì½”ë“œë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•©ë‹ˆë‹¤.
    strategy:
      fail-fast: false # í•˜ë‚˜ì˜ ë¦¬í¬íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë¦¬í¬íŠ¸ëŠ” ê³„ì† ì‹¤í–‰ë©ë‹ˆë‹¤.
      matrix:
        # ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ëŠ” ì„ íƒëœ ê°’ì„, ê·¸ ì™¸ì—ëŠ” ê¸°ë³¸ê°’ 'daily'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        # ì´ ë§¤íŠ¸ë¦­ìŠ¤ëŠ” ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ì•„ë˜ 'Determine report types' ë‹¨ê³„ì—ì„œ í•„í„°ë§ë©ë‹ˆë‹¤.
        report_type: [ 'daily', 'weekly', 'monthly' ]

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (v4 ì‚¬ìš©, ê²½ë¡œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ 'path' ì˜µì…˜ ì œê±°)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js í™˜ê²½ ì„¤ì • (v4 ì‚¬ìš©)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. NPM ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. (ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ) ì˜¤ëŠ˜ ì‹¤í–‰í•  ë¦¬í¬íŠ¸ ì¢…ë¥˜ ê²°ì •
      - name: Determine report types to run on schedule
        id: get_reports
        # ì´ ë‹¨ê³„ëŠ” 'schedule' ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        if: github.event_name == 'schedule'
        run: |
          REPORTS_TO_RUN=""
          # ë§¤ì¼ ì‹¤í–‰ë˜ë¯€ë¡œ 'daily'ëŠ” í•­ìƒ í¬í•¨
          REPORTS_TO_RUN="daily"
          
          # ì˜¤ëŠ˜ì´ ì›”ìš”ì¼(1)ì´ë©´ 'weekly' ì¶”ê°€
          if [[ $(date -u +%u) == 1 ]]; then
            REPORTS_TO_RUN="$REPORTS_TO_RUN weekly"
          fi

          # ì˜¤ëŠ˜ì´ 1ì¼ì´ë©´ 'monthly' ì¶”ê°€
          if [[ $(date -u +%d) == "01" ]]; then
            REPORTS_TO_RUN="$REPORTS_TO_RUN monthly"
          fi
          
          echo "reports=${REPORTS_TO_RUN}" >> "$GITHUB_OUTPUT"
          echo "âœ… Reports to run today: ${REPORTS_TO_RUN}"

      # 5. ë¦¬í¬íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Generate Report
        # ì•„ë˜ ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¥¼ ë§Œì¡±í•  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤:
        # - ìˆ˜ë™ ì‹¤í–‰('workflow_dispatch')ì´ê³ , ë§¤íŠ¸ë¦­ìŠ¤ì˜ report_typeì´ ì„ íƒëœ ê°’ê³¼ ì¼ì¹˜í•  ë•Œ
        # - ìŠ¤ì¼€ì¤„ ì‹¤í–‰('schedule')ì´ê³ , ì˜¤ëŠ˜ ì‹¤í–‰í•´ì•¼ í•  ë¦¬í¬íŠ¸ ì¢…ë¥˜ì— í˜„ì¬ ë§¤íŠ¸ë¦­ìŠ¤ì˜ report_typeì´ í¬í•¨ë  ë•Œ
        if: |
          (github.event_name == 'workflow_dispatch' && matrix.report_type == github.event.inputs.report_type) ||
          (github.event_name == 'schedule' && contains(steps.get_reports.outputs.reports, matrix.report_type))
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_DM_USER_IDS: ${{ secrets.SLACK_DM_USER_IDS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TZ: Asia/Seoul
        # matrix.report_type ê°’ì„ Node.js ìŠ¤í¬ë¦½íŠ¸ì˜ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        run: node generate-full-report.js ${{ matrix.report_type }}

  # ===============================================
  # ==          ë¡œì§ í…ŒìŠ¤íŠ¸ ì‘ì—… (Push/PR)          ==
  # ===============================================
  test-logic:
    name: Test Grouping Logic
    runs-on: ubuntu-latest
    # ì´ ì‘ì—…ì€ 'push' ë˜ëŠ” 'pull_request' ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Test Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # í…ŒìŠ¤íŠ¸ì— í•„ìš”í•œ ìµœì†Œí•œì˜ secretsë§Œ ì „ë‹¬
          TZ: Asia/Seoul
        run: |
          echo "ğŸ§ª Testing grouping logic..."
          node test-grouping-logic.js
          echo "âœ… Grouping logic test completed"
