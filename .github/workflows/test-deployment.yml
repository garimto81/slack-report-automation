name: Test GitHub Actions Environment

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'setup'
        type: choice
        options:
          - setup          # ê¸°ë³¸ ì²´í¬ì•„ì›ƒ ë° Node.js ì„¤ì • í…ŒìŠ¤íŠ¸
          - dependencies   # ì˜ì¡´ì„± ì„¤ì¹˜ í…ŒìŠ¤íŠ¸  
          - full          # ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸

env:
  TZ: Asia/Seoul

jobs:
  test-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Show environment info
        run: |
          echo "ğŸŒ Environment Information"
          echo "=========================="
          echo "ğŸ—‚ï¸  Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Working directory: $(pwd)"
          echo "ğŸ• Current time: $(date)"
          echo ""
          
      - name: List repository contents
        run: |
          echo "ğŸ“‹ Repository Contents"
          echo "====================="
          ls -la
          echo ""
          echo "ğŸ“ .github directory:"
          ls -la .github/workflows/ || echo "No workflows directory"
          
      - name: Setup Node.js
        if: inputs.test_type != 'setup-only'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Verify package files
        if: inputs.test_type != 'setup-only'
        run: |
          echo "ğŸ“¦ Package Files Check"
          echo "====================="
          if [ -f "package.json" ]; then
            echo "âœ… package.json found"
            echo "ğŸ“„ package.json size: $(wc -c < package.json) bytes"
          else
            echo "âŒ package.json NOT found!"
            exit 1
          fi
          
          if [ -f "package-lock.json" ]; then
            echo "âœ… package-lock.json found"
            echo "ğŸ“„ package-lock.json size: $(wc -c < package-lock.json) bytes"
          else
            echo "âŒ package-lock.json NOT found!"
            exit 1
          fi
          
      - name: Test npm ci installation
        if: inputs.test_type == 'dependencies' || inputs.test_type == 'full'
        run: |
          echo "ğŸ“¦ Testing npm ci installation"
          echo "=============================="
          npm ci
          echo ""
          echo "âœ… npm ci completed successfully"
          echo "ğŸ“ node_modules created:"
          ls -la node_modules/ | head -10
          echo "..."
          echo "ğŸ“Š Total packages: $(ls node_modules/ | wc -l)"
          
      - name: Verify dependencies
        if: inputs.test_type == 'dependencies' || inputs.test_type == 'full'
        run: |
          echo "ğŸ” Dependency Verification"
          echo "=========================="
          echo "ğŸ“¦ Checking required packages:"
          
          # Check main dependencies
          if [ -d "node_modules/@slack/web-api" ]; then
            echo "âœ… @slack/web-api installed"
          else
            echo "âŒ @slack/web-api missing!"
            exit 1
          fi
          
          if [ -d "node_modules/@google/generative-ai" ]; then
            echo "âœ… @google/generative-ai installed"
          else
            echo "âŒ @google/generative-ai missing!"
            exit 1
          fi
          
      - name: Test script syntax
        if: inputs.test_type == 'full'
        run: |
          echo "ğŸ§ª Script Syntax Test"
          echo "===================="
          
          # Test main script syntax without executing
          if [ -f "generate-full-report.js" ]; then
            echo "ğŸ” Checking generate-full-report.js syntax:"
            node -c generate-full-report.js
            echo "âœ… Syntax check passed"
          else
            echo "âŒ generate-full-report.js not found!"
            exit 1
          fi
          
          # Test other JS files
          for jsfile in *.js; do
            if [ -f "$jsfile" ] && [ "$jsfile" != "generate-full-report.js" ]; then
              echo "ğŸ” Checking $jsfile syntax:"
              node -c "$jsfile" && echo "âœ… $jsfile syntax OK" || echo "âŒ $jsfile syntax error"
            fi
          done
          
      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ¯ Test Summary"
          echo "==============="
          echo "Test type: ${{ inputs.test_type }}"
          echo "Status: ${{ job.status }}"
          echo "Time: $(date)"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ All tests passed! GitHub Actions environment is ready."
          else
            echo "âŒ Some tests failed. Check the logs above for details."
          fi