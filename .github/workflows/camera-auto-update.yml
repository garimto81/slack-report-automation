name: Camera Part Auto Update

on:
  schedule:
    # 평일 오전 10시 (UTC 01:00 = KST 10:00)
    # 월-금요일: 0 1 * * 1-5
    - cron: '0 1 * * 1-5'
  
  # 수동 실행 가능
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run regardless of time/day restrictions'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-camera-part:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
        
    - name: Create service account key file
      run: echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' > service-account-key-fixed.json
        
    - name: Create environment file
      run: |
        cat << EOF > .env
        SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
        SLACK_CHANNEL_ID=${{ secrets.SLACK_CHANNEL_ID }}
        GOOGLE_SERVICE_ACCOUNT_KEY=${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        GOOGLE_DOCS_ID=${{ secrets.GOOGLE_DOCS_ID }}
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        EOF
        
    - name: Run automated camera update
      run: node automated-camera-update.js
      env:
        TZ: 'Asia/Seoul'
        FORCE_RUN: ${{ github.event.inputs.force_run }}
        
    - name: Log execution result
      if: always()
      run: |
        echo "Workflow executed at: $(TZ='Asia/Seoul' date)"
        echo "Exit code: $?"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Camera update failed at $(TZ='Asia/Seoul' date)" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs and verify:" >> $GITHUB_STEP_SUMMARY
        echo "- Slack API connection" >> $GITHUB_STEP_SUMMARY
        echo "- Google Docs API access" >> $GITHUB_STEP_SUMMARY
        echo "- Gemini API availability" >> $GITHUB_STEP_SUMMARY
        
    - name: Success summary
      if: success()
      run: |
        echo "✅ Camera part update completed successfully at $(TZ='Asia/Seoul' date)" >> $GITHUB_STEP_SUMMARY
        echo "📊 Updated 3 camera tasks in Google Docs" >> $GITHUB_STEP_SUMMARY